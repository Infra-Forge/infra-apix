# CLI Usage Guide

Complete guide to using the `apix` command-line tool.

## Table of Contents

- [Installation](#installation)
- [Commands](#commands)
- [Generate Command](#generate-command)
- [Spec-Guard Command](#spec-guard-command)
- [CI/CD Integration](#cicd-integration)
- [Examples](#examples)

## Installation

### Install from Source

```bash
go install github.com/Infra-Forge/apix/cmd/apix@latest
```

### Install Specific Version

```bash
go install github.com/Infra-Forge/apix/cmd/apix@v0.2.0
```

### Verify Installation

```bash
apix --help
```

## Commands

The `apix` CLI provides two main commands:

1. **`generate`** - Generate OpenAPI spec from registered routes
2. **`spec-guard`** - Check for drift between generated and committed specs

## Generate Command

Generate OpenAPI specification from your Go code.

### Basic Usage

```bash
apix generate
```

This generates `docs/openapi.yaml` with default settings.

### Flags

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--project` | string | `.` | Path to Go project root |
| `--out` | string | `docs/openapi.yaml` | Output file path |
| `--format` | string | `yaml` | Output format (`yaml` or `json`) |
| `--title` | string | `API` | API title |
| `--version` | string | `1.0.0` | API version |
| `--servers` | string | - | Comma-separated server URLs |
| `--stdout` | bool | `false` | Write to stdout instead of file |
| `--validate` | bool | `true` | Validate generated spec |

### Examples

#### Generate YAML Spec

```bash
apix generate \
  --title "My API" \
  --version "1.0.0" \
  --out docs/openapi.yaml
```

#### Generate JSON Spec

```bash
apix generate \
  --format json \
  --out docs/openapi.json
```

#### Add Server URLs

```bash
apix generate \
  --servers "https://api.example.com,https://staging.example.com" \
  --out docs/openapi.yaml
```

#### Output to Stdout

```bash
apix generate --stdout > openapi.yaml
```

#### Custom Project Path

```bash
apix generate \
  --project /path/to/project \
  --out /path/to/output/openapi.yaml
```

### Generated File Format

The generated file includes a DO-NOT-EDIT header:

```yaml
# DO NOT EDIT -- generated by apix generate -- update Go handlers instead

openapi: 3.1.0
info:
  title: My API
  version: 1.0.0
paths:
  /api/users:
    post:
      summary: Create a new user
      ...
```

### Validation

By default, the CLI validates the generated spec using kin-openapi:

```bash
# Validation enabled (default)
apix generate --validate

# Skip validation
apix generate --validate=false
```

Validation errors will cause the command to fail with exit code 1.

## Spec-Guard Command

Check for drift between generated spec and committed spec. Useful in CI/CD pipelines.

### Basic Usage

```bash
apix spec-guard
```

This compares the generated spec against `docs/openapi.yaml`.

### Flags

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--existing` | string | value of `--out` | Path to existing spec file |
| `--out` | string | `docs/openapi.yaml` | Expected spec path |

### Exit Codes

- **0**: No drift detected (specs match)
- **1**: Drift detected or error occurred

### Examples

#### Check Default Spec

```bash
apix spec-guard
```

#### Check Custom Spec

```bash
apix spec-guard --existing docs/api-spec.yaml
```

#### Check with Custom Output Path

```bash
apix spec-guard \
  --out docs/openapi.yaml \
  --existing docs/openapi.yaml
```

### Drift Detection

The command performs a byte-by-byte comparison of:
1. Freshly generated spec from current code
2. Committed spec file

If they differ, it means:
- Routes were added/removed
- Request/response models changed
- Documentation was updated
- Security schemes changed

**Example output when drift detected:**

```
apix spec-guard: spec drift detected at docs/openapi.yaml; run 'apix generate' to update the committed spec
```

## CI/CD Integration

### GitHub Actions

Add to `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      
      - name: Install apix CLI
        run: go install github.com/Infra-Forge/apix/cmd/apix@latest
      
      - name: Run tests
        run: go test ./...
      
      - name: Check OpenAPI spec drift
        run: apix spec-guard --existing docs/openapi.yaml
```

### GitLab CI

Add to `.gitlab-ci.yml`:

```yaml
test:
  image: golang:1.25
  script:
    - go install github.com/Infra-Forge/apix/cmd/apix@latest
    - go test ./...
    - apix spec-guard --existing docs/openapi.yaml
```

### Pre-commit Hook

Add to `.git/hooks/pre-commit`:

```bash
#!/bin/bash

echo "Checking OpenAPI spec drift..."
apix spec-guard --existing docs/openapi.yaml

if [ $? -ne 0 ]; then
    echo "❌ OpenAPI spec drift detected!"
    echo "Run 'apix generate' to update the spec"
    exit 1
fi

echo "✅ OpenAPI spec is up to date"
```

Make it executable:

```bash
chmod +x .git/hooks/pre-commit
```

### Makefile Integration

Add to `Makefile`:

```makefile
.PHONY: generate-spec
generate-spec:
	@echo "Generating OpenAPI spec..."
	@apix generate \
		--title "My API" \
		--version "1.0.0" \
		--servers "https://api.example.com" \
		--out docs/openapi.yaml

.PHONY: check-spec
check-spec:
	@echo "Checking OpenAPI spec drift..."
	@apix spec-guard --existing docs/openapi.yaml

.PHONY: ci
ci: test check-spec
	@echo "CI checks passed!"
```

Usage:

```bash
make generate-spec  # Generate spec
make check-spec     # Check for drift
make ci             # Run all CI checks
```

## Examples

### Complete Workflow

```bash
# 1. Develop your API
# ... write handlers, register routes ...

# 2. Generate spec
apix generate \
  --title "My API" \
  --version "1.0.0" \
  --servers "https://api.example.com" \
  --out docs/openapi.yaml

# 3. Review generated spec
cat docs/openapi.yaml

# 4. Commit the spec
git add docs/openapi.yaml
git commit -m "docs: update OpenAPI spec"

# 5. In CI, check for drift
apix spec-guard --existing docs/openapi.yaml
```

### Multi-Environment Setup

```bash
# Production spec
apix generate \
  --title "My API" \
  --version "1.0.0" \
  --servers "https://api.example.com" \
  --out docs/openapi.prod.yaml

# Staging spec
apix generate \
  --title "My API (Staging)" \
  --version "1.0.0-staging" \
  --servers "https://staging.example.com" \
  --out docs/openapi.staging.yaml

# Development spec
apix generate \
  --title "My API (Dev)" \
  --version "1.0.0-dev" \
  --servers "http://localhost:8080" \
  --out docs/openapi.dev.yaml
```

### Version-Specific Specs

```bash
# Generate spec for v1
apix generate \
  --title "My API v1" \
  --version "1.0.0" \
  --out docs/openapi.v1.yaml

# Generate spec for v2
apix generate \
  --title "My API v2" \
  --version "2.0.0" \
  --out docs/openapi.v2.yaml
```

### Integration with go:generate

Add to your Go file:

```go
//go:generate apix generate --title "My API" --version "1.0.0" --out docs/openapi.yaml

package main
```

Then run:

```bash
go generate ./...
```

## Troubleshooting

### No Routes Registered

**Error:**
```
apix generate: no routes registered; ensure your handlers register with apix
```

**Solution:**
Make sure your code registers routes before running the CLI. The CLI needs to import and execute your code to discover routes.

### Spec Validation Failed

**Error:**
```
apix generate: validate openapi: ...
```

**Solution:**
Fix the validation errors in your route definitions. Common issues:
- Missing required fields
- Invalid schema types
- Circular references

### File Permission Error

**Error:**
```
apix generate: write spec: permission denied
```

**Solution:**
Ensure you have write permissions to the output directory:

```bash
mkdir -p docs
chmod 755 docs
```

### Drift Detected

**Error:**
```
apix spec-guard: spec drift detected
```

**Solution:**
Regenerate the spec:

```bash
apix generate --out docs/openapi.yaml
git add docs/openapi.yaml
git commit -m "docs: update OpenAPI spec"
```

## Best Practices

1. **Commit Generated Specs**
   - Always commit generated specs to version control
   - Use `spec-guard` in CI to prevent drift

2. **Use Semantic Versioning**
   - Update `--version` flag when making breaking changes
   - Follow semver conventions (MAJOR.MINOR.PATCH)

3. **Document Server URLs**
   - Include all relevant environments
   - Use HTTPS for production URLs

4. **Validate in CI**
   - Always run `spec-guard` in CI pipelines
   - Fail builds on drift detection

5. **Automate Generation**
   - Use Makefile or scripts for consistent generation
   - Include in pre-commit hooks

6. **Version Control**
   - Keep specs in `docs/` directory
   - Use descriptive filenames (e.g., `openapi.v2.yaml`)

7. **Review Changes**
   - Review spec diffs in pull requests
   - Ensure changes match code changes

